#' @title Comparative Genomics Analysis Pipeline: QUAST Metrics
#' @description This script performs quality control analysis, normalization, 
#' and visualization of genomic assembly metrics generated by QUAST. 
#' It produces publication-ready figures (Lollipop, Dot Plot, Bar Charts) 
#' and statistical tables.
#'
#' @author [Seu Nome] (ORCID: 0000-XXXX-XXXX-XXXX)
#' @date 2026-02-17
#' @version 1.1.3 (Environment Locked)
#' @license MIT License
#' @doi 10.5281/zenodo.XXXXX (Placeholder)
#'
#' @dependencies
#' - R version 4.5.2
#' - Bioconductor version 3.22
#' - Core Packages: tidyverse (>= 2.0.0), ggplot2, patchworks, openxlsx, viridis

# ==============================================================================
# 1. SETUP AND LIBRARIES
# ==============================================================================

suppressPackageStartupMessages({
  library(tidyverse)
  library(ggplot2)
  library(ggpubr)
  library(patchwork)
  library(openxlsx)
  library(viridis)
  library(scales)
})

# ==============================================================================
# 2. HELPER FUNCTIONS
# ==============================================================================

#' Load and Tidy QUAST Data
#' @description Reads raw QUAST tabular reports and metadata, merges them, 
#' and transforms data into a tidy format.
#' @param path_quast Path to the QUAST tabular report.
#' @param path_meta Path to the metadata TSV.
#' @param sample_order Factor levels for sample ordering.
load_and_tidy_data <- function(path_quast, path_meta, sample_order) {
  
  # Integrity checks
  if (!file.exists(path_quast)) stop("Error: QUAST file not found at: ", normalizePath(path_quast, mustWork = FALSE))
  if (!file.exists(path_meta)) stop("Error: Metadata file not found at: ", normalizePath(path_meta, mustWork = FALSE))
  
  # Load Data
  metadados <- readr::read_tsv(path_meta, show_col_types = FALSE)
  quast_raw <- readr::read_tsv(path_quast, show_col_types = FALSE)
  
  # Tidy Transformation
  quast_long <- quast_raw %>%
    tidyr::pivot_longer(cols = -Assembly, names_to = "Sample", values_to = "Value") %>%
    dplyr::rename(Metric = Assembly) %>%
    dplyr::left_join(metadados, by = c("Sample" = "QUAST")) %>%
    dplyr::mutate(
      Sample_Name = dplyr::coalesce(Nome_Real, Sample),
      Value_Numeric = suppressWarnings(as.numeric(Value))
    ) %>%
    dplyr::filter(!is.na(Value_Numeric)) %>%
    dplyr::mutate(Sample_Name = factor(Sample_Name, levels = sample_order))
  
  return(quast_long)
}

#' Generate Scientific Theme
#' @description Returns a standardized ggplot2 theme for Nature-like publication.
theme_nature <- function() {
  theme_bw() +
    theme(
      text = element_text(family = "sans", size = 11),
      plot.title = element_text(face = "bold", size = 12),
      axis.title = element_text(face = "bold", size = 10),
      axis.text = element_text(color = "black", size = 9),
      legend.position = "none",
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank()
    )
}

#' Create Lollipop Chart for Fragmentation
plot_lollipop <- function(data, colors) {
  ggplot(data, aes(x = Sample_Name, y = Value_Numeric)) +
    geom_segment(aes(x = Sample_Name, xend = Sample_Name, y = 0, yend = Value_Numeric), 
                 color = "grey50", linewidth = 0.6) +
    geom_point(aes(color = Sample_Name), size = 4) +
    geom_text(aes(label = Value_Numeric), vjust = -0.5, size = 3, hjust = -0.3) +
    scale_color_manual(values = colors) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
    coord_flip() +
    labs(title = "A. Assembly Fragmentation", 
         subtitle = "Lower values indicate better continuity (# Contigs)",
         y = "Number of Contigs", x = NULL) +
    theme_nature()
}

#' Create Dot Plot for Genome Size
plot_genome_size <- function(data, colors) {
  data <- data %>% dplyr::mutate(Value_Mb = Value_Numeric / 1e6)
  ggplot(data, aes(x = Sample_Name, y = Value_Mb)) +
    annotate("rect", xmin = -Inf, xmax = Inf, ymin = 4.5, ymax = 5.5, 
             alpha = 0.1, fill = "blue") + 
    geom_point(aes(fill = Sample_Name), shape = 21, size = 3.5, color = "black") +
    scale_fill_manual(values = colors) +
    coord_flip() +
    scale_y_continuous(breaks = seq(4, 6, 0.5)) +
    labs(title = "B. Genome Size", 
         subtitle = "Shaded area: Typical E. coli range (4.5-5.5 Mb)",
         y = "Size (Mb)", x = NULL) +
    theme_nature()
}

#' Create Horizontal Bar Chart for N50
plot_n50 <- function(data, colors) {
  data <- data %>% dplyr::mutate(Value_Mb = Value_Numeric / 1e6)
  ggplot(data, aes(x = Sample_Name, y = Value_Mb, fill = Sample_Name)) +
    geom_col(width = 0.7, color = "black", linewidth = 0.2) +
    geom_text(aes(label = round(Value_Mb, 2)), hjust = -0.2, size = 3) +
    scale_fill_manual(values = colors) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
    coord_flip() +
    labs(title = "C. Assembly Contiguity (N50)", 
         subtitle = "Higher values indicate longer contigs",
         y = "N50 (Mb)", x = NULL) +
    theme_nature()
}

#' Create Diverging Bar Chart for GC Content
plot_gc_divergence <- function(data, colors) {
  data <- data %>%
    dplyr::mutate(
      GC_Ref = 50.6,
      Diff = Value_Numeric - GC_Ref
    )
  ggplot(data, aes(x = Sample_Name, y = Diff)) +
    geom_col(aes(fill = Sample_Name), width = 0.6, color = "black", linewidth = 0.2) +
    geom_hline(yintercept = 0, color = "black", linewidth = 0.5) +
    scale_fill_manual(values = colors) +
    coord_flip() +
    labs(title = "D. GC Content Deviation", 
         subtitle = "Deviation from expected mean (50.6%)",
         y = "Difference from 50.6% GC", x = NULL) +
    theme_nature() +
    theme(axis.text.x = element_text(size = 8))
}

#' Export Formatted Excel Table
save_excel_report <- function(raw_data, metadata, output_path) {
  metrics_of_interest <- c("# contigs", "Largest contig", "Total length", "GC (%)", 
                           "N50", "L50", "# misassemblies", "Genome fraction (%)")
  
  table_final <- raw_data %>%
    dplyr::filter(Assembly %in% metrics_of_interest)
  
  new_names <- purrr::map_chr(names(table_final)[-1], function(x) {
    match <- metadata$Nome_Real[metadata$QUAST == x]
    if(length(match) > 0) match else x
  })
  names(table_final) <- c("Metric", new_names)
  
  wb <- openxlsx::createWorkbook()
  openxlsx::addWorksheet(wb, "Metrics")
  openxlsx::writeData(wb, "Metrics", table_final, 
                      headerStyle = createStyle(textDecoration = "bold", fgFill = "#DCE6F1"))
  openxlsx::setColWidths(wb, "Metrics", cols = 1:ncol(table_final), widths = "auto")
  openxlsx::saveWorkbook(wb, output_path, overwrite = TRUE)
}

# ==============================================================================
# 3. MAIN EXECUTION BLOCK (RELATIVE PATHS)
# ==============================================================================

# Definição dinâmica: Arquivos devem estar na mesma pasta do projeto/script
# "Current Working Directory" será usado como base.

CONFIG <- list(
  FILE_QUAST = "Galaxy11-[Quast on dataset 1-10_ tabular report].tabular",
  FILE_META  = "Metadados.tsv",
  DIR_OUT    = "outputs" # Outputs will be saved in './outputs'
)

SAMPLE_ORDER <- c(
  "K-12 MG1655 (negative control)", "O157:H7 Sakai (reference)", "O157:H7 EDL933",
  "O145:H28 RM12581", "O121:H19 FWSEC0006", "O111:H8 7-58 72A",
  "O104:H4 2011C 3493", "O103:H2 12009", "O45:H2 FWSEC0003", "O26:H11 11368"
)

main <- function() {
  
  # Detectar diretório atual
  current_wd <- getwd()
  cat("\n[INFO] Environment: R v4.5.2 / Bioconductor v3.22\n")
  cat("[INFO] Current Working Directory:", current_wd, "\n")
  
  # Configurar caminhos completos baseados na pasta atual
  path_quast_file <- file.path(current_wd, CONFIG$FILE_QUAST)
  path_meta_file  <- file.path(current_wd, CONFIG$FILE_META)
  dir_output      <- file.path(current_wd, CONFIG$DIR_OUT)
  
  cat("[1/4] Checking environment and paths...\n")
  if (!dir.exists(dir_output)) {
    dir.create(dir_output, recursive = TRUE)
    cat(" > Output directory 'outputs' created:", dir_output, "\n")
  }
  
  # 1. Load Data
  cat("[2/4] Loading and Tidying Data...\n")
  quast_tidy <- load_and_tidy_data(path_quast_file, path_meta_file, SAMPLE_ORDER)
  
  # 2. Export Table
  cat("[3/4] Exporting Tabular Data...\n")
  quast_raw_for_table <- readr::read_tsv(path_quast_file, show_col_types = FALSE)
  meta_for_table <- readr::read_tsv(path_meta_file, show_col_types = FALSE)
  save_excel_report(quast_raw_for_table, meta_for_table, file.path(dir_output, "Table_QUAST_Assembly_Metrics.xlsx"))
  
  # 3. Generate Visualization
  cat("[4/4] Generating and Saving Plots...\n")
  colors_strains <- viridis(10, option = "D", direction = -1)
  
  p1 <- plot_lollipop(quast_tidy %>% filter(Metric == "# contigs"), colors_strains)
  p2 <- plot_genome_size(quast_tidy %>% filter(Metric == "Total length"), colors_strains)
  p3 <- plot_n50(quast_tidy %>% filter(Metric == "N50"), colors_strains)
  p4 <- plot_gc_divergence(quast_tidy %>% filter(Metric == "GC (%)"), colors_strains)
  
  layout_final <- (p1 | p2) / (p3 | p4) +
    plot_annotation(
      title = "Comparative Metrics of E. coli Genome Assemblies",
      caption = "Source: Galaxy/QUAST Analysis pipeline.",
      theme = theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
    )
  
  ggsave(
    filename = file.path(dir_output, "Figure_QUAST_Combined_Nature.png"),
    plot = layout_final,
    width = 14, height = 10, dpi = 600, bg = "white"
  )
  
  stats <- quast_tidy %>%
    group_by(Metric) %>%
    summarise(
      Mean = mean(Value_Numeric, na.rm = TRUE),
      Min = min(Value_Numeric, na.rm = TRUE),
      Max = max(Value_Numeric, na.rm = TRUE)
    )
  readr::write_csv(stats, file.path(dir_output, "QUAST_Statistics_Summary.csv"))
  
  # Enhanced Session Info with version tracking
  writeLines(c(
    paste("Pipeline Run Date:", Sys.time()),
    paste("R Version:", R.version.string),
    "Bioconductor: v3.22 (Expected)",
    capture.output(sessionInfo())
  ), file.path(dir_output, "session_info.txt"))
  
  cat("\n✓ PIPELINE COMPLETED SUCCESSFULLY.\n")
  cat("✓ Results saved in:", dir_output, "\n")
}

# Execute Main
if (!interactive()) {
  main()
} else {
  cat("Script loaded. Run 'main()' to execute.\n")
}